## 8.0 割り込み

割り込み機能により、特定のイベントが通常のプログラムフローを先取りすることができます。
 ファームウェアは、割り込みの原因を特定し、それに応じて動作するために使用されます。
 一部の割り込みは、MCUをスリープモードから復帰させるように構成できます。
 この章には、割り込みに関する次の情報が含まれています。
•オペレーション
•割り込みレイテンシ
•スリープ中の割り込み
•INTピン
•自動コンテキスト保存
多くの周辺機器が割り込みを生成します。
 詳細については、対応する章を参照してください。
 割り込みロジックのブロック図を図8-1と図8-2に示します。


## 8.1 Operation

割り込みは、デバイスのリセット時に無効になります。
 これらは、次のビットを設定することで有効になります。
•INTCONレジスタのGIEビット
•特定の割り込みイベントの割り込み有効化ビット
•INTCONレジスタのPEIEビット（割り込みイベントの割り込みイネーブルビットがPIExレジスタに含まれている場合）

INTCON、PIR1、PIR2、PIR3、およびPIR4レジスタは、割り込みフラグビットを介して個々の割り込みを記録します。
 割り込みフラグビットは、GIE、PEIE、および個々の割り込みイネーブルビットのステータスに関係なく設定されます。

 GIEビットが設定されているときに割り込みイベントが発生すると、次のイベントが発生します。
•現在プリフェッチされている命令がフラッシュされる
•GIEビットがクリアされる
•現在のプログラムカウンター（PC）がスタックにプッシュされます。
•重要なレジスタは自動的にシャドウレジスタに保存されます（8.5「自動コンテキスト保存」を参照）。
•PCに割り込みベクター0004hがロードされている

割り込みサービスルーチン（ISR）内のファームウェアは、割り込みフラグビットをポーリングして、割り込みのソースを判別する必要があります。
 ISRを終了する前に、割り込みフラグビットをクリアして、割り込みが繰り返されないようにする必要があります。
 GIEビットがクリアされているため、ISRの実行中に発生した割り込みは、その割り込みフラグを通じて記録されますが、プロセッサが割り込みベクトルにリダイレクトされることはありません。
 RETFIE命令は、スタックから以前のアドレスをポップし、保存されたコンテキストをシャドウレジスタから復元してGIEビットを設定することにより、ISRを終了します。
 特定の割り込みの動作の詳細については、その周辺の章を参照してください。

注1：他のイネーブルビットの状態に関係なく、個々の割り込みフラグビットが設定されます。
  2：GIEビットがクリアされている間、すべての割り込みは無視されます。
  GIEビットがクリアされている間に発生した割り込みは、GIEビットが再度セットされたときに処理されます。

## 8.2 Interrupt Latency

割り込みレイテンシは、割り込みイベントが発生してから、割り込みベクトルでコードの実行が始まるまでの時間として定義されます。
 同期割り込みのレイテンシは3または4命令サイクルです。
 非同期割り込みの場合、割り込みが発生するタイミングに応じて、レイテンシは3〜5命令サイクルです。
 詳細については、図8-3および図8.3を参照してください。

## 8.3 Interrupts During Sleep

一部の割り込みは、スリープからの復帰に使用できます。
 スリープから復帰するには、ペリフェラルがシステムクロックなしで動作できる必要があります。
 割り込みソースは、スリープに入る前に、適切な割り込み有効ビットが設定されている必要があります。
 スリープからの復帰時に、GIEビットも設定されている場合、プロセッサは割り込みベクトルに分岐します。
 それ以外の場合、プロセッサはSLEEP命令の後も命令を実行し続けます。
 SLEEP命令の直後の命令は、常にISRに分岐する前に実行されます。
 詳細はセクション9.0「PowerDownモード（スリープ）」を参照してください。

## 8.4 INT Pin

INTピンを使用して、非同期エッジトリガー割り込みを生成できます。
 この割り込みは、INTCONレジスタのINTEビットをセットすると有効になります。
 OPTIONレジスタのINTEDGビットは、割り込みが発生するエッジを決定します。
 INTEDGビットが設定されると、立ち上がりエッジで割り込みが発生します。
 INTEDGビットがクリアされている場合、立ち下がりエッジで割り込みが発生します。
 INTCONレジスタのINTFビットは、INTピンに有効なエッジが現れるとセットされます。
 GIEビットとINTEビットも設定されている場合、プロセッサはプログラムの実行を割り込みベクトルにリダイレクトします。

## 8.5 Automatic Context Saving

割り込みに入ると、リターンPCアドレスがスタックに保存されます。
 さらに、次のレジスタがシャドウレジスタに自動的に保存されます。
•Wレジスタ
•ステータスレジスタ（TOおよびPDを除く）
•BSRレジスタ
•FSRレジスタ
•PCLATHレジスタ
割り込みサービスルーチンを終了すると、これらのレジスタは自動的に復元されます。
 ISR中にこれらのレジスタに加えられた変更は失われます。
 これらのレジスタのいずれかに変更が必要な場合は、対応するシャドウレジスタを変更する必要があり、ISRを終了すると値が復元されます。
 シャドウレジスタはバンク31で使用でき、読み取りおよび書き込みが可能です。
 ユーザーのアプリケーションによっては、他のレジスタも保存する必要がある場合があります。