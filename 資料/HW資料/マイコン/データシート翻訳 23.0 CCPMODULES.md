# データシート翻訳 23.0



## 23.0 CAPTURE/COMPARE/PWM MODULES

キャプチャ/比較/ PWMモジュールは、ユーザーがさまざまなイベントの時間を計って制御し、パルス幅変調（PWM）信号を生成できるペリフェラルです。
 キャプチャモードでは、ペリフェラルはイベント期間のタイミングを許可します。
 比較モードでは、所定の時間が経過したときにユーザーが外部イベントをトリガーできます。
 PWMモードでは、さまざまな周波数とデューティサイクルのパルス幅変調信号を生成できます。
 このデバイスファミリには、2つの拡張キャプチャ/比較/ PWMモジュール（ECCP1およびECCP2）と2つの標準キャプチャ/比較/ PWMモジュール（CCP3およびCCP4）が含まれています。
 キャプチャ機能と比較機能は、4つのCCPモジュール（ECCP1、ECCP2、CCP3、およびCCP4）すべてで同じです。
 CCPモジュール間の唯一の違いは、パルス幅変調（PWM）機能です。
 標準のPWM機能は、モジュールCCP3とCCP4で同じです。
 CCPモジュールECCP1およびECCP2では、拡張PWM機能は互いにわずかに異なります。
 フルブリッジECCPモジュールには4つの利用可能なI / Oピンがありますが、ハーフブリッジECCPモジュールには2つの利用可能なI / Oピンしかありません。
 詳細については、表23-1を参照してください。

 注1：複数のCCPモジュールを備えたデバイスでは、使用するレジスタ名に細心の注意を払うことが非常に重要です。
  モジュールの頭字語の後にある数字は、個別のモジュールを区別するために使用されます。
  たとえば、CCP1CONとCCP2CONは、2つの完全に異なるCCPモジュールの同じ動作面を制御します。
  2：このセクション全体を通して、その動作モードのいずれかでのCCPモジュールへの一般的な参照は、ECCP1、ECCP2、CCP3、およびCCP4に等しく適用可能であると解釈される場合があります。
  レジスタ名、モジュール信号、I / Oピン、およびビット名は、必要に応じて、一般的な指定子「x」を使用して、特定のモジュールを区別する数字の使用を示すことができます。



## 23.1 Capture Mode
このセクションで説明するキャプチャモード機能は、CCPモジュールECCP1、ECCP2、CCP3、およびCCP4で使用でき、同じです。
 キャプチャモードでは、16ビットのTimer1リソースを使用します。
 CCPxピンでイベントが発生すると、16ビットのCCPRxH：CCPRxLレジスタペアが、TMR1H：TMR1Lレジスタペアの16ビット値をそれぞれキャプチャして保存します。
 イベントは次のいずれかとして定義され、CCPxCONレジスタのCCPxM <3：0>ビットで構成されます。

•すべての立ち下がりエッジ  
•すべての立ち上がりエッジ  
•4番目ごとの立ち上がりエッジ  
•16番目ごとの立ち上がりエッジ

キャプチャが行われると、PIRxレジスタの割り込み要求フラグビットCCPxIFがセットされます。
 割り込みフラグはソフトウェアでクリアする必要があります。
 CCPRxH、CCPRxLレジスタペアの値が読み取られる前に別のキャプチャが発生すると、古いキャプチャ値が新しいキャプチャ値で上書きされます。
 図23-1に、キャプチャ操作の簡略図を示します。
 23.1.1 CCPピンの設定キャプチャモードでは、関連するTRIS制御ビットを設定して、CCPxピンを入力として設定する必要があります。
 また、CCPxピン機能は、APFCON0またはAPFCON1レジスタを使用して代替ピンに移動できます。
 詳細はセクション12.1「代替ピンの機能」を参照してください。



## 23.2 Compare Mode

このセクションで説明する比較モード機能は、CCPモジュールECCP1、ECCP2、CCP3、およびCCP4で使用でき、同じです。
 比較モードは、16ビットのTimer1リソースを使用します。
 CCPRxH：CCPRxLレジスタペアの16ビット値は、TMR1H：TMR1Lレジスタペアの16ビット値と常に比較されます。
 一致すると、次のいずれかのイベントが発生する可能性があります。

•CCPx出力を切り替える  
•CCPx出力を設定する  
•CCPx出力をクリアする  
•特別なイベントトリガーを生成する  
•ソフトウェア割り込みを生成する

ピンの動作は、CCPxCONレジスタのCCPxM<3：0>制御ビットの値に基づいています。
 同時に、割り込みフラグCCPxIFビットがセットされます。
 すべての比較モードで割り込みを生成できます。
 図23-2は、比較操作の簡略図を示しています。

### 23.2.1 CCP PIN CONFIGURATION

ユーザーは、関連するTRISビットをクリアして、CCPxピンを出力として構成する必要があります。
 また、CCPxピン機能は、APFCONレジスタを使用して代替ピンに移動できます。
 詳細はセクション12.1「代替ピンの機能」を参照してください。

注：CCPxCONレジスタをクリアすると、CCPx比較出力ラッチがデフォルトのLowレベルに強制されます。
  これはPORT I / Oデータラッチではありません。

### 23.2.2 TIMER1 MODE RESOURCE

比較モードでは、Timer1はTimerモードまたはSynchronized Counterモードのいずれかで実行されている必要があります。
 非同期カウンタモードでは、比較操作が機能しない場合があります。
 Timer1の設定の詳細は、セクション23.2.2「Timer1モードのリソース」を参照してください。

注：システムクロック（FOSC）からのTimer1のクロッキングは、比較モードでは使用しないでください。
  比較モードでCCPxピンのトリガーイベントを認識するために、TImer1は命令クロック（FOSC / 4）または外部クロックソースからクロック供給される必要があります。

### 23.2.3 SOFTWARE INTERRUPT MODE

ソフトウェア割り込みモードを選択すると（CCPxM<3：0> = 1010）、CCPxモジュールはCCPxピンの制御をアサートしません（CCPxCONレジスタを参照）。

### 23.2.4 SPECIAL EVENT TRIGGER

スペシャルイベントトリガーモードが選択されている場合（CCPxM <3：0> = 1011）、CCPxモジュールは
以下：
•Timer1をリセットします
•ADCが有効な場合、ADC変換を開始します
CCPxモジュールは、このモードではCCPxピンの制御をアサートしません。
 CCPの特殊イベントトリガー出力は、TMR1H、TMR1LレジスタペアとCCPRxH、CCPRxLレジスタペアが一致するとすぐに発生します。
 TMR1H、TMR1Lレジスタペアは、Timer1クロックの次の立ち上がりエッジまでリセットされません。
 スペシャルイベントトリガー出力は、A / D変換を開始します（A / Dモジュールが有効な場合）。
 これにより、CCPRxH、CCPRxLレジスタペアで、Timer1に16ビットのプログラム可能な周期レジスタを効果的に提供できます。

注1：CCPモジュールからの特殊イベントトリガーは、PIR1レジスタの割り込みフラグビットTMR1IFを設定しません。
  2：特殊イベントトリガーを生成するクロックエッジとTimer1リセットを生成するクロックエッジの間で、CCPRxHおよびCCPRxLレジスタペアの内容を変更して一致条件を削除すると、リセットが発生しなくなります。

## 15.2.5 SPECIAL EVENT TRIGGER

CCPx / ECCPXモジュールの特殊イベントトリガーにより、ソフトウェアの介入なしに定期的なADC測定が可能になります。
 このトリガーが発生すると、ハードウェアによってGO / DONEビットが設定され、Timer1カウンターがゼロにリセットされます。

Special Event Triggerを使用しても、適切なADCタイミングは保証されません。
 ADCタイミング要件が満たされていることを確認するのはユーザーの責任です。
 詳細は、セクション23.0「キャプチャ/比較/ PWMモジュール」を参照してください。

### 23.3 PWM Overview

パルス幅変調（PWM）は、完全にオンの状態と完全にオフの状態をすばやく切り替えることにより、負荷に電力を供給する方式です。
 PWM信号は方形波に似ており、信号の高い部分はオン状態と見なされ、信号の低い部分はオフ状態と見なされます。
 パルス幅とも呼ばれる高い部分は、時間とともに変化する可能性があり、段階的に定義されます。
 適用されるステップ数が多いほど、パルス幅が長くなり、負荷により多くの電力が供給されます。
 適用されるステップ数を減らすと、パルス幅が短くなり、消費電力が少なくなります。
 PWM周期は、1つの完全なサイクルの期間、またはオン時間とオフ時間の合計で定義されます。
 PWM分解能は、単一のPWM周期に存在できる最大ステップ数を定義します。
 分解能が高いほど、パルス幅の時間をより正確に制御でき、負荷に適用される電力を制御できます。
デューティサイクルという用語は、オン時間とオフ時間の比率を表し、パーセンテージで表されます。0％は完全にオフ、100％は完全にオンです。
 デューティサイクルが低いと、適用される電力が少なくなり、デューティサイクルが高いと、適用される電力が多くなります。
 図23-3に、PWM信号の標準的な波形を示します。
 23.3.1標準PWM動作このセクションで説明する標準PWM機能は、CCPモジュールECCP1、ECCP2、CCP3、およびCCP4で使用でき、同じです。
 標準PWMモードは、最大10ビットの分解能でCCPxピンにパルス幅変調（PWM）信号を生成します。
 周期、デューティサイクル、および分解能は、次のレジスタによって制御されます。
•PRxレジスタ
•TxCONレジスタ
•CCPRxLレジスタ
•CCPxCONレジスタ
図23-4に、PWM動作の簡略ブロック図を示します。


注1：CCPxピンのPWM出力を有効にするには、対応するTRISビットをクリアする必要があります。
2：CCPxCONレジスタをクリアすると、CCPxピンの制御が放棄されます。


FIGURE 23-4: SIMPLIFIED PWM BLOCK DIAGRAM

注1：8ビットタイマーTMRxレジスタは、2ビットの内部システムクロック（FOSC）またはプリスケーラーの2ビットと連結されて、10ビットのタイムベースを作成します。
2：PWMモードでは、CCPRxHは読み取り専用レジスタです。

### 23.3.2 SETUP FOR PWM OPERATION

CCPモジュールを標準PWM動作用に構成する場合は、次の手順を実行する必要があります。
1.関連するTRISビットを設定して、CCPxピン出力ドライバーを無効にします。
2. PRxレジスタにPWM周期値をロードします。
3. CCPxCONレジスタに適切な値をロードして、CCPモジュールをPWMモードに設定します。
4. CCPRxLレジスタとCCPxCONレジスタのDCxBxビットにPWMデューティサイクル値をロードします。
5. Timer2 / 4/6を構成して開始します。
  •CCPTMRSレジスタのCxTSEL <1：0>ビットを設定して、PWM生成に使用するTimer2 / 4/6リソースを選択します。
  •PIRxレジスタのTMRxIF割り込みフラグビットをクリアします。以下の注を参照してください。
  •TxCONレジスタのTxCKPSビットをタイマープリスケール値で構成します。
  •TxCONレジスタのTMRxONビットをセットしてタイマーを有効にします。
6. PWM出力ピンを有効にします。
  •タイマーがオーバーフローし、PIRxレジスタのTMRxIFビットがセットされるまで待ちます。以下の注を参照してください。
  •関連するTRISビットをクリアして、CCPxピン出力ドライバーを有効にします。

注：最初のPWM出力で完全なデューティサイクルと周期を送信するには、上記の手順をセットアップシーケンスに含める必要があります。
 最初の出力で完全なPWM信号から開始することが重要でない場合は、手順6は無視できます。

### 23.3.3 TIMER2/4/6 TIMER RESOURCE

PWM標準モードは、8ビットTimer2 / 4/6タイマーリソースの1つを使用して、PWM周期を指定します。
CCPTMRSレジスタのCxTSEL <1：0>ビットを構成すると、使用するTimer2 / 4/6タイマーが選択されます。


### 23.3.4 PWM PERIOD

PWM周期は、Timer2 / 4/6のPRxレジスタで指定されます。
 PWM周期は、式12-1の式を使用して計算できます。

TMRxがPRxと等しい場合、次の3つのイベントが次のインクリメントサイクルで発生します。
•TMRxがクリアされる
•CCPxピンが設定されている。 （例外：PWMデューティサイクル= 0％の場合、ピンは設定されません。）
•PWMデューティサイクルは、CCPRxLからCCPRxHにラッチされます。


Note：タイマーポストスケーラー（セクション21.1「Timer2 / 4/6の動作」を参照）は、PWM周波数の決定には使用されません。


### 23.3.5 PWM DUTY CYCLE

PWMデューティサイクルは、複数のレジスタ（CCPRxLレジスタとCCPxCONレジスタのDCxB <1：0>ビット）に10ビット値を書き込むことによって指定されます。
 CCPRxLには8つのMSbが含まれ、CCPxCONレジスタのDCxB <1：0>ビットには2つのLSbが含まれます。
 CCPxCONレジスタのCCPRxLおよびDCxB <1：0>ビットはいつでも書き込むことができます。
 デューティサイクル値は、期間が終了するまで（つまり、PRxレジスタとTMRxレジスタ間の一致が発生するまで）、CCPRxHにラッチされません。
 PWMを使用している間、CCPRxHレジスタは読み取り専用です。
 式12-2は、PWMパルス幅の計算に使用されます。
 式12-3は、PWMデューティサイクル比を計算するために使用されます。

CCPRxHレジスタと2ビットの内部ラッチを使用して、PWMデューティサイクルをダブルバッファリングします。
  このダブルバッファリングは、グリッチのないPWM動作に不可欠です。
  8ビットタイマーTMRxレジスタは、2ビットの内部システムクロック（FOSC）またはプリスケーラーの2ビットと連結して、10ビットのタイムベースを作成します。
  Timer2 / 4/6プリスケーラが1：1に設定されている場合、システムクロックが使用されます。
  10ビットのタイムベースがCCPRxHおよび2ビットのラッチと一致すると、CCPxピンがクリアされます（図23-4を参照）。

### 23.3.6 PWM RESOLUTION

分解能は、特定の期間に使用可能なデューティサイクルの数を決定します。
 たとえば、10ビットの分解能では1024のデューティサイクルが発生しますが、8ビットの分解能では256のデューティサイクルが発生します。
 PRxが255の場合、最大PWM分解能は10ビットです。
 分解能は、式12-4に示すように、PRxレジスタ値の関数です。

### 23.3.7 OPERATION IN SLEEP MODE

スリープモードでは、TMRxレジスタはインクリメントせず、モジュールの状態は変化しません。
 CCPxピンが値を駆動している場合、その値を駆動し続けます。
 デバイスがウェイクアップすると、TMRxは以前の状態から継続します。

### 23.3.8 CHANGES IN SYSTEM CLOCK FREQUENCY

PWM周波数は、システムクロック周波数から導出されます。
 システムクロック周波数を変更すると、PWM周波数も変更されます。
 詳細はセクション5.0「オシレータモジュール（フェイルセーフクロックモニタを使用）」を参照してください。

### 23.3.9 EFFECTS OF RESET

リセットすると、すべてのポートが強制的に入力モードになり、CCPレジスタがリセット状態になります。


### 23.3.10 ALTERNATE PIN LOCATIONS

このモジュールには、代替ピン機能レジスタAPFCON0およびAPFCON1を使用して他の場所に移動できるI / Oピンが組み込まれています。
 移動できるピンとリセット時のデフォルトの場所を確認するには、セクション12.1「代替ピンの機能」を参照してください。