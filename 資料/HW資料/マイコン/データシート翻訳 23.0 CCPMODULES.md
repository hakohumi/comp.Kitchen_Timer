# データシート翻訳 23.0



## 23.0 CAPTURE/COMPARE/PWM MODULES

キャプチャ/比較/ PWMモジュールは、ユーザーがさまざまなイベントの時間を計って制御し、パルス幅変調（PWM）信号を生成できるペリフェラルです。
 キャプチャモードでは、ペリフェラルはイベント期間のタイミングを許可します。
 比較モードでは、所定の時間が経過したときにユーザーが外部イベントをトリガーできます。
 PWMモードでは、さまざまな周波数とデューティサイクルのパルス幅変調信号を生成できます。
 このデバイスファミリには、2つの拡張キャプチャ/比較/ PWMモジュール（ECCP1およびECCP2）と2つの標準キャプチャ/比較/ PWMモジュール（CCP3およびCCP4）が含まれています。
 キャプチャ機能と比較機能は、4つのCCPモジュール（ECCP1、ECCP2、CCP3、およびCCP4）すべてで同じです。
 CCPモジュール間の唯一の違いは、パルス幅変調（PWM）機能です。
 標準のPWM機能は、モジュールCCP3とCCP4で同じです。
 CCPモジュールECCP1およびECCP2では、拡張PWM機能は互いにわずかに異なります。
 フルブリッジECCPモジュールには4つの利用可能なI / Oピンがありますが、ハーフブリッジECCPモジュールには2つの利用可能なI / Oピンしかありません。
 詳細については、表23-1を参照してください。

 注1：複数のCCPモジュールを備えたデバイスでは、使用するレジスタ名に細心の注意を払うことが非常に重要です。
  モジュールの頭字語の後にある数字は、個別のモジュールを区別するために使用されます。
  たとえば、CCP1CONとCCP2CONは、2つの完全に異なるCCPモジュールの同じ動作面を制御します。
  2：このセクション全体を通して、その動作モードのいずれかでのCCPモジュールへの一般的な参照は、ECCP1、ECCP2、CCP3、およびCCP4に等しく適用可能であると解釈される場合があります。
  レジスタ名、モジュール信号、I / Oピン、およびビット名は、必要に応じて、一般的な指定子「x」を使用して、特定のモジュールを区別する数字の使用を示すことができます。



## 23.1 Capture Mode
このセクションで説明するキャプチャモード機能は、CCPモジュールECCP1、ECCP2、CCP3、およびCCP4で使用でき、同じです。
 キャプチャモードでは、16ビットのTimer1リソースを使用します。
 CCPxピンでイベントが発生すると、16ビットのCCPRxH：CCPRxLレジスタペアが、TMR1H：TMR1Lレジスタペアの16ビット値をそれぞれキャプチャして保存します。
 イベントは次のいずれかとして定義され、CCPxCONレジスタのCCPxM <3：0>ビットで構成されます。

•すべての立ち下がりエッジ  
•すべての立ち上がりエッジ  
•4番目ごとの立ち上がりエッジ  
•16番目ごとの立ち上がりエッジ

キャプチャが行われると、PIRxレジスタの割り込み要求フラグビットCCPxIFがセットされます。
 割り込みフラグはソフトウェアでクリアする必要があります。
 CCPRxH、CCPRxLレジスタペアの値が読み取られる前に別のキャプチャが発生すると、古いキャプチャ値が新しいキャプチャ値で上書きされます。
 図23-1に、キャプチャ操作の簡略図を示します。
 23.1.1 CCPピンの設定キャプチャモードでは、関連するTRIS制御ビットを設定して、CCPxピンを入力として設定する必要があります。
 また、CCPxピン機能は、APFCON0またはAPFCON1レジスタを使用して代替ピンに移動できます。
 詳細はセクション12.1「代替ピンの機能」を参照してください。



## 23.2 Compare Mode

このセクションで説明する比較モード機能は、CCPモジュールECCP1、ECCP2、CCP3、およびCCP4で使用でき、同じです。
 比較モードは、16ビットのTimer1リソースを使用します。
 CCPRxH：CCPRxLレジスタペアの16ビット値は、TMR1H：TMR1Lレジスタペアの16ビット値と常に比較されます。
 一致すると、次のいずれかのイベントが発生する可能性があります。

•CCPx出力を切り替える  
•CCPx出力を設定する  
•CCPx出力をクリアする  
•特別なイベントトリガーを生成する  
•ソフトウェア割り込みを生成する

ピンの動作は、CCPxCONレジスタのCCPxM<3：0>制御ビットの値に基づいています。
 同時に、割り込みフラグCCPxIFビットがセットされます。
 すべての比較モードで割り込みを生成できます。
 図23-2は、比較操作の簡略図を示しています。

### 23.2.1 CCP PIN CONFIGURATION

ユーザーは、関連するTRISビットをクリアして、CCPxピンを出力として構成する必要があります。
 また、CCPxピン機能は、APFCONレジスタを使用して代替ピンに移動できます。
 詳細はセクション12.1「代替ピンの機能」を参照してください。

注：CCPxCONレジスタをクリアすると、CCPx比較出力ラッチがデフォルトのLowレベルに強制されます。
  これはPORT I / Oデータラッチではありません。

### 23.2.2 TIMER1 MODE RESOURCE

比較モードでは、Timer1はTimerモードまたはSynchronized Counterモードのいずれかで実行されている必要があります。
 非同期カウンタモードでは、比較操作が機能しない場合があります。
 Timer1の設定の詳細は、セクション23.2.2「Timer1モードのリソース」を参照してください。

注：システムクロック（FOSC）からのTimer1のクロッキングは、比較モードでは使用しないでください。
  比較モードでCCPxピンのトリガーイベントを認識するために、TImer1は命令クロック（FOSC / 4）または外部クロックソースからクロック供給される必要があります。

### 23.2.3 SOFTWARE INTERRUPT MODE

ソフトウェア割り込みモードを選択すると（CCPxM<3：0> = 1010）、CCPxモジュールはCCPxピンの制御をアサートしません（CCPxCONレジスタを参照）。

### 23.2.4 SPECIAL EVENT TRIGGER

スペシャルイベントトリガーモードが選択されている場合（CCPxM <3：0> = 1011）、CCPxモジュールは
以下：
•Timer1をリセットします
•ADCが有効な場合、ADC変換を開始します
CCPxモジュールは、このモードではCCPxピンの制御をアサートしません。
 CCPの特殊イベントトリガー出力は、TMR1H、TMR1LレジスタペアとCCPRxH、CCPRxLレジスタペアが一致するとすぐに発生します。
 TMR1H、TMR1Lレジスタペアは、Timer1クロックの次の立ち上がりエッジまでリセットされません。
 スペシャルイベントトリガー出力は、A / D変換を開始します（A / Dモジュールが有効な場合）。
 これにより、CCPRxH、CCPRxLレジスタペアで、Timer1に16ビットのプログラム可能な周期レジスタを効果的に提供できます。

注1：CCPモジュールからの特殊イベントトリガーは、PIR1レジスタの割り込みフラグビットTMR1IFを設定しません。
  2：特殊イベントトリガーを生成するクロックエッジとTimer1リセットを生成するクロックエッジの間で、CCPRxHおよびCCPRxLレジスタペアの内容を変更して一致条件を削除すると、リセットが発生しなくなります。

## 15.2.5 SPECIAL EVENT TRIGGER

CCPx / ECCPXモジュールの特殊イベントトリガーにより、ソフトウェアの介入なしに定期的なADC測定が可能になります。
 このトリガーが発生すると、ハードウェアによってGO / DONEビットが設定され、Timer1カウンターがゼロにリセットされます。

Special Event Triggerを使用しても、適切なADCタイミングは保証されません。
 ADCタイミング要件が満たされていることを確認するのはユーザーの責任です。
 詳細は、セクション23.0「キャプチャ/比較/ PWMモジュール」を参照してください。